"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,a=new Array(r);t<r;t++)a[t]=e[t];return a}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}!function(e,r){var t=function(){function glTFBase64Tool(){_classCallCheck(this,glTFBase64Tool)}return _createClass(glTFBase64Tool,null,[{key:"init",value:function(){if(!glTFBase64Tool.lookup){glTFBase64Tool.lookup=new Uint8Array(256);for(var e=0;e<glTFBase64Tool.chars.length;e++)glTFBase64Tool.lookup[glTFBase64Tool.chars.charCodeAt(e)]=e}}},{key:"isBase64String",value:function(e){return glTFBase64Tool.reg.test(e)}},{key:"encode",value:function(e){var r,t=new Uint8Array(e),a=t.length,n="";for(r=0;r<a;r+=3)n+=glTFBase64Tool.chars[t[r]>>2],n+=glTFBase64Tool.chars[(3&t[r])<<4|t[r+1]>>4],n+=glTFBase64Tool.chars[(15&t[r+1])<<2|t[r+2]>>6],n+=glTFBase64Tool.chars[63&t[r+2]];return a%3==2?n=n.substring(0,n.length-1)+"=":a%3==1&&(n=n.substring(0,n.length-2)+"=="),n}},{key:"decode",value:function(e){glTFBase64Tool.init();var r,t,a,n,l,o=.75*e.length,s=e.length,i=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var u=new ArrayBuffer(o),g=new Uint8Array(u);for(r=0;r<s;r+=4)t=glTFBase64Tool.lookup[e.charCodeAt(r)],a=glTFBase64Tool.lookup[e.charCodeAt(r+1)],n=glTFBase64Tool.lookup[e.charCodeAt(r+2)],l=glTFBase64Tool.lookup[e.charCodeAt(r+3)],g[i++]=t<<2|a>>4,g[i++]=(15&a)<<4|n>>2,g[i++]=(3&n)<<6|63&l;return u}}]),glTFBase64Tool}();t.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,t.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,t.lookup=null;var a=function(){function glTFTextureEditor(){_classCallCheck(this,glTFTextureEditor)}return _createClass(glTFTextureEditor,null,[{key:"PixelArrayToBase64",value:function(e,t,a){var n=new Uint8ClampedArray(e),l=new ImageData(n,t,a),o=new r.HTMLCanvas(!0),s=o.source.getContext("2d");return o.source.width=t,o.source.height=a,s.putImageData(l,0,0),o.source.toDataURL()}},{key:"GenerateTexture2DWithPixel",value:function(e,t,a,n,l){var o=new r.Texture2D(t,a,n,l,!0);if(o.setPixels(e),l){var s=r.LayaGL.instance;r.WebGLContext.bindTexture(s,o._glTextureType,o._glTexture),s.generateMipmap(o._glTextureType),r.WebGLContext.bindTexture(s,o._glTextureType,null)}return o}},{key:"glTFOcclusionTrans",value:function(e){for(var t=e.getPixels(),a=new Uint8Array(t.length),n=t.length/4,l=0;l<n;l++){var o=4*l,s=t[o+0];a[o+1]=s}return glTFTextureEditor.GenerateTexture2DWithPixel(a,e.width,e.height,r.TextureFormat.R8G8B8A8,e.mipmap)}},{key:"glTFMetallicGlossTrans",value:function(e,t,a){for(var n=e.getPixels(),l=new Uint8Array(n.length),o=e.width*e.height,s=0;s<o;s++){var i=4*s,u=n[i+2]*t,g=255-n[i+1]*a;l[i+0]=u,l[i+3]=g}return glTFTextureEditor.GenerateTexture2DWithPixel(l,e.width,e.height,r.TextureFormat.R8G8B8A8,e.mipmap)}}]),glTFTextureEditor}(),n=function PrimitiveSubMesh(){_classCallCheck(this,PrimitiveSubMesh)},l=function ClipNode(){_classCallCheck(this,ClipNode)},o=function(){function glTFUtils(){_classCallCheck(this,glTFUtils)}return _createClass(glTFUtils,null,[{key:"_parse",value:function(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(glTFUtils._initData(e),!glTFUtils._checkglTFVersion(this._glTF.asset))return console.warn("glTF version wrong!"),new r.Sprite3D;glTFUtils._initBufferData(e.buffers),glTFUtils._initTextureData(e.images),glTFUtils._loadMaterials(e.materials),glTFUtils._loadNodes(e.nodes),glTFUtils.buildHierarchy(e.nodes),glTFUtils._loadScenes(e.scenes),glTFUtils._loadAnimations(e.animations);var t=null!=e.scene?e.scene:0,a=glTFUtils._glTFScenes[t];return glTFUtils._clearData(),a}},{key:"_initData",value:function(e){glTFUtils._glTF=e,e.buffers&&(glTFUtils._glTFBuffers.length=e.buffers.length),e.textures&&(glTFUtils._glTFTextures.length=e.textures.length),e.materials&&(glTFUtils._glTFMaterials.length=e.materials.length),e.nodes&&(glTFUtils._glTFNodes.length=e.nodes.length),e.scenes&&(glTFUtils._glTFScenes.length=e.scenes.length)}},{key:"_clearData",value:function(){glTFUtils._glTF=null,glTFUtils._glTFBuffers.length=0,glTFUtils._glTFTextures.length=0,glTFUtils._glTFMaterials.length=0,glTFUtils._glTFNodes.length=0,glTFUtils._glTFScenes.length=0,glTFUtils.NAMEID=0}},{key:"_checkglTFVersion",value:function(e){return"2.0"===e.version}},{key:"RegisterExtra",value:function(e,r,t){(glTFUtils.Extras[e]||(glTFUtils.Extras[e]={}))[r]=t}},{key:"UnRegisterExtra",value:function(e,r){var t=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=glTFUtils.Extras[e]||(glTFUtils.Extras[e]={});if(t){var n=a[r];n&&n.recover()}delete a[r]}},{key:"ExecuteExtras",value:function(e,r,t,a){var n=glTFUtils.Extras[e],l=null;if(n)for(var o in r){var s=n[o];l=s?s.runWith([].concat(_toConsumableArray(a),[t])):l}return l=l||t.runWith(a),t.recover(),l}},{key:"getNodeRandomName",value:function(e){return"".concat(e,"_").concat(glTFUtils.NAMEID++)}},{key:"_initBufferData",value:function(e){e&&e.forEach(function(e,t){glTFUtils._glTFBuffers[t]=r.Loader.getRes(e.uri)})}},{key:"getAccessorComponentsNum",value:function(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 0}}},{key:"getAttributeNum",value:function(e){switch(e){case"POSITION":case"NORMAL":return 3;case"COLOR":return 4;case"UV":case"UV1":return 2;case"BLENDWEIGHT":case"BLENDINDICES":case"TANGENT":return 4;default:return 0}}},{key:"_getTypedArrayConstructor",value:function(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array}}},{key:"getBufferwithAccessorIndex",value:function(e){var r=glTFUtils._glTF.accessors[e];if(!r)return null;var t=glTFUtils._glTF.bufferViews[r.bufferView],a=glTFUtils._glTFBuffers[t.buffer],n=r.count,l=glTFUtils.getAccessorComponentsNum(r.type),o=(t.byteOffset||0)+(r.byteOffset||0),s=n*l;return new(glTFUtils._getTypedArrayConstructor(r.componentType))(a,o,s)}},{key:"_initTextureData",value:function(e){e&&e.forEach(function(e,t){glTFUtils._glTFTextures[t]=r.Loader.getRes(e.uri)})}},{key:"getTextureMipmap",value:function(e){return!e||(9729===e.minFilter||9728===e.minFilter)}},{key:"getTextureFormat",value:function(e){return"image/png"===e.mimeType?1:0}},{key:"getTextureFilterMode",value:function(e){return e?9728===e.magFilter?0:glTFUtils.getTextureMipmap(e)&&9987===e.minFilter?2:1:1}},{key:"getTextureWrapMode",value:function(e){return 33071===e?1:0}},{key:"getTextureConstructParams",value:function(e,r){var t=[];return t[0]=0,t[1]=0,t[2]=glTFUtils.getTextureFormat(e),t[3]=glTFUtils.getTextureMipmap(r),t[4]=!0,t}},{key:"getTexturePropertyParams",value:function(e){var r={};return e?(r.filterMode=glTFUtils.getTextureFilterMode(e),r.wrapModeU=glTFUtils.getTextureWrapMode(e.wrapS),r.wrapModeV=glTFUtils.getTextureWrapMode(e.wrapT),r.anisoLevel=16,r):null}},{key:"getTexturewithInfo",value:function(e){e.texCoord&&console.warn("glTF Loader: non 0 uv channel unsupported.");var r=glTFUtils._glTF.textures[e.index];return glTFUtils._glTFTextures[r.source]}},{key:"_loadMaterials",value:function(e){e&&e.forEach(function(e,r){glTFUtils._glTFMaterials[r]=glTFUtils._loadMaterial(e)})}},{key:"_loadMaterial",value:function(e){if(e.extras){var t=r.Handler.create(this,glTFUtils._createdefaultMaterial,null,!1);return glTFUtils.ExecuteExtras("MATERIAL",e.extras,t,[e])}return glTFUtils._createdefaultMaterial(e)}},{key:"_createdefaultMaterial",value:function(e){var t=new r.PBRStandardMaterial;if(t.name=e.name?e.name:"",e.pbrMetallicRoughness&&glTFUtils.applyPBRMetallicRoughness(e.pbrMetallicRoughness,t),e.normalTexture&&(t.normalTexture=glTFUtils.getTexturewithInfo(e.normalTexture),null!=e.normalTexture.scale&&(t.normalTextureScale=e.normalTexture.scale)),e.occlusionTexture){var n=glTFUtils.getTexturewithInfo(e.occlusionTexture);t.occlusionTexture=a.glTFOcclusionTrans(n),null!=e.occlusionTexture.strength&&(t.occlusionTextureStrength=e.occlusionTexture.strength)}switch(e.emissiveTexture&&(t.emissionTexture=glTFUtils.getTexturewithInfo(e.emissiveTexture),t.emissionTexture&&(t.enableEmission=!0)),e.emissiveFactor&&(t.emissionColor.fromArray(e.emissiveFactor),t.emissionColor.w=1,t.enableEmission=!0),e.alphaMode||"OPAQUE"){case"OPAQUE":t.renderMode=r.PBRRenderMode.Opaque;break;case"BLEND":t.renderMode=r.PBRRenderMode.Transparent;break;case"MASK":t.renderMode=r.PBRRenderMode.Cutout}return null!=e.alphaCutoff&&(t.alphaTestValue=e.alphaCutoff),e.doubleSided&&(t.cull=r.RenderState.CULL_NONE),t}},{key:"applyPBRMetallicRoughness",value:function(e,r){e.baseColorFactor&&r.albedoColor.fromArray(e.baseColorFactor),e.baseColorTexture&&(r.albedoTexture=glTFUtils.getTexturewithInfo(e.baseColorTexture));var t=r.metallic=1;null!=e.metallicFactor&&(t=r.metallic=e.metallicFactor);var n=1;if(r.smoothness=0,null!=e.roughnessFactor&&(n=e.roughnessFactor,r.smoothness=1-e.roughnessFactor),e.metallicRoughnessTexture){var l=glTFUtils.getTexturewithInfo(e.metallicRoughnessTexture);r.metallicGlossTexture=a.glTFMetallicGlossTrans(l,t,n)}}},{key:"pickMeshMaterials",value:function(e){var t=[];return e.primitives.forEach(function(e){if(null!=e.material){var a=glTFUtils._glTFMaterials[e.material];t.push(a)}else{var n=new r.PBRStandardMaterial;t.push(n),glTFUtils._glTFMaterials.push(n),e.material=glTFUtils._glTFMaterials.indexOf(n)}}),t}},{key:"_loadScenes",value:function(e){e&&e.forEach(function(e,r){glTFUtils._glTFScenes[r]=glTFUtils._loadScene(e)})}},{key:"_loadScene",value:function(e){return glTFUtils._createSceneNode(e)}},{key:"_createSceneNode",value:function(e){var t=new r.Sprite3D(e.name||"glTF_Scene_node");return e.nodes.forEach(function(e){var r=glTFUtils._glTFNodes[e];t.addChild(r)}),t}},{key:"applyTransform",value:function(e,r){if(e.matrix){var t=r.transform.localMatrix;t.elements.set(e.matrix),r.transform.localMatrix=t}else{var a=r.transform.localPosition,n=r.transform.localRotation,l=r.transform.localScale;e.translation&&a.fromArray(e.translation),e.rotation&&n.fromArray(e.rotation),e.scale&&l.fromArray(e.scale),r.transform.localPosition=a,r.transform.localRotation=n,r.transform.localScale=l}}},{key:"buildHierarchy",value:function(e){e.forEach(function(e,r){var t=glTFUtils._glTFNodes[r];e.children&&e.children.forEach(function(e){var r=glTFUtils._glTFNodes[e];t.addChild(r)})}),e.forEach(function(e,t){var a=glTFUtils._glTFNodes[t];a instanceof r.SkinnedMeshSprite3D&&glTFUtils.fixSkinnedSprite(e,a)})}},{key:"_loadNodes",value:function(e){e&&(e.forEach(function(e,r){e.name=e.name||glTFUtils.getNodeRandomName("node")}),e.forEach(function(e,r){glTFUtils._glTFNodes[r]=glTFUtils._loadNode(e)}))}},{key:"_loadNode",value:function(e){return glTFUtils._createSprite3D(e)}},{key:"_createSprite3D",value:function(e){if(e.name=e.name,null!=e.skin){var t=glTFUtils._createSkinnedMeshSprite3D(e);return glTFUtils.applyTransform(e,t),t}if(null!=e.mesh){var a=glTFUtils._createMeshSprite3D(e);return glTFUtils.applyTransform(e,a),a}var n=new r.Sprite3D(e.name);return glTFUtils.applyTransform(e,n),n}},{key:"_createMeshSprite3D",value:function(e){var t=glTFUtils._glTF.meshes[e.mesh],a=glTFUtils._loadMesh(t),n=glTFUtils.pickMeshMaterials(t),l=new r.MeshSprite3D(a,e.name);return l.meshRenderer.sharedMaterials=n,l}},{key:"_createSkinnedMeshSprite3D",value:function(e){var t=glTFUtils._glTF.meshes[e.mesh],a=glTFUtils._glTF.skins[e.skin],n=glTFUtils._loadMesh(t,a),l=glTFUtils.pickMeshMaterials(t),o=new r.SkinnedMeshSprite3D(n,e.name);return o.skinnedMeshRenderer.sharedMaterials=l,o}},{key:"getArrributeBuffer",value:function(e,r,t,a){var n=glTFUtils.getBufferwithAccessorIndex(e);if(!n)return null;a.push(r);var l=n;return t.set(r,l),l}},{key:"getIndexBuffer",value:function(e,r){var t=glTFUtils.getBufferwithAccessorIndex(e);if(t)return new Uint32Array(t).reverse();for(var a=new Uint32Array(r),n=0;n<r;n++)a[n]=n;return a}},{key:"parseMeshwithSubMeshData",value:function(e,t){var a=0,n=0,l=void 0;e.forEach(function(e){a+=e.vertexCount,n+=e.indices.length,l=l||e.vertexDecler});var o,s=r.VertexMesh.getVertexDeclaration(l,!1),i=s.vertexStride/4,u=new Float32Array(i*a),g=r.IndexFormat.UInt32;a<65536?(o=new Uint16Array(n),g=r.IndexFormat.UInt16):o=new Uint32Array(n),glTFUtils.fillMeshBuffers(e,u,o,i),glTFUtils.generatMesh(u,o,s,g,e,t)}},{key:"fillMeshBuffers",value:function(e,r,t,a){var n=0,l=0,o=0;e.forEach(function(e){for(var s=n,i=e.vertexCount,u=e.indices,g=0;g<u.length;g++)t[s+g]=u[g]+l;n+=u.length,l+=i;var c=function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=o+t,s=0;s<i;s++)for(var u=0;u<n;u++)r[l+s*a+u]=e[s*n+u]},f=0,T=e.attributeMap,d=T.get("POSITION");d&&(c(d,f,3),f+=3);var h=T.get("NORMAL");h&&(c(h,f,3),f+=3);var F=T.get("COLOR");F&&(c(F,f,4),f+=4);var v=T.get("UV");v&&(c(v,f,2),f+=2);var _=T.get("UV1");_&&(c(_,f,2),f+=2);var y=T.get("BLENDWEIGHT");y&&(c(y,f,4),f+=4);var m=T.get("BLENDINDICES");if(m){var p=new Uint8Array(m);c(new Float32Array(p.buffer),f,1),f+=1}var x=T.get("TANGENT");x&&(c(x,f,4),f+=4),o+=i*a})}},{key:"splitSubMeshByBonesCount",value:function(e,r,t,a,n){for(var l=glTFUtils.maxSubBoneCount,o=0,s=new Set,i=e.get("BLENDINDICES"),u=i.length/4,g=new Float32Array(i.length),c=new Array(u).fill(!1),f=0,T=r.length;f<T;f+=3){for(var d=new Set,h=f;h<f+3;h++)for(var F=4*r[h],v=0;v<4;v++)d.add(i[F+v]);var _=new Set([].concat(_toConsumableArray(s),_toConsumableArray(d)));if(_.size>l){var y=f-o;a.push(o),n.push(y);var m=Array.from(s);t.push(new Uint16Array(m)),o=f,s=new Set(d)}else s=_;if(f==T-3){var p=f-o+3;a.push(o),n.push(p),o=f;var x=Array.from(s);t.push(new Uint16Array(x))}}var U=t.length,A=new Map;e.forEach(function(e,r){var t=new Array;A.set(r,t)});for(var L=u-1,M=0;M<U;M++){for(var w=a[M],E=n[M],B=t[M],b=new Array(u).fill(!1),k=new Map,S=function(t){for(var a=r[t+w],n=4*a,l=n;l<n+4;l++){var o=i[l],s=B.indexOf(o);s=-1==s?0:s,c[a]&&!b[a]?A.get("BLENDINDICES").push(s):c[a]&&b[a]||(g[l]=s)}c[a]||b[a]?!c[a]&&b[a]?r[t+w]=k.get(a):c[a]&&!b[a]?(b[a]=!0,L++,k.set(a,L),r[t+w]=L,A.forEach(function(r,t){var n=glTFUtils.getAttributeNum(t),l=e.get(t);if("BLENDINDICES"!==t)for(var o=0;o<n;o++)r.push(l[o+a*n])})):c[a]&&b[a]&&(r[t+w]=k.get(a)):(b[a]=!0,k.set(a,a))},C=0;C<E;C++)S(C);b.forEach(function(e,r){c[r]=e||c[r]})}A.forEach(function(r,t){var a=e.get(t);"BLENDINDICES"==t&&(a=g);var n=a.length+r.length,l=new Float32Array(n);l.set(a,0),l.set(r,a.length),e.set(t,l)}),i=null}},{key:"generatMesh",value:function(e,t,a,n,l,o){var s=r.LayaGL.instance,i=new r.VertexBuffer3D(e.byteLength,s.STATIC_DRAW,!0);i.vertexDeclaration=a,i.setData(e.buffer);var u=new r.IndexBuffer3D(n,t.length,s.STATIC_DRAW,!0);u.setData(t),o._indexFormat=n,o._indexBuffer=u,o._vertexBuffer=i,o._setBuffer(i,u),o._vertexCount=i._byteLength/a.vertexStride;for(var g=0,c=l.length,f=new Array(c),T=0;T<c;T++){var d=l[T],h=new r.SubMesh(o);f[T]=h,h._vertexBuffer=i,h._indexBuffer=u;var F=g;g+=d.indices.length;var v=d.indices.length;h._setIndexRange(F,v,n),h._boneIndicesList=d.boneIndicesList,h._subIndexBufferStart=d.subIndexStartArray,h._subIndexBufferCount=d.subIndexCountArray;for(var _=0;_<h._subIndexBufferStart.length;_++)h._subIndexBufferStart[_]+=F}o._setSubMeshes(f),o.calculateBounds();var y=i._byteLength+u._byteLength;o._setCPUMemory(y),o._setGPUMemory(y)}},{key:"applyglTFSkinData",value:function(e,t,a){if(a){var n=a.joints,l=new Float32Array(glTFUtils.getBufferwithAccessorIndex(a.inverseBindMatrices)),o=n.length,s=e._boneNames=[];n.forEach(function(e){var r=glTFUtils._glTF.nodes[e];s.push(r.name)}),e._inverseBindPoses=[],e._inverseBindPosesBuffer=l.buffer,e._setInstanceBuffer(r.Mesh.MESH_INSTANCEBUFFER_TYPE_NORMAL);for(var i=0;i<o;i++){var u=16*i,g=l.slice(u,u+16);e._inverseBindPoses[i]=new r.Matrix4x4(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15],g)}var c=t.length,f=e._skinnedMatrixCaches;f.length=e._inverseBindPoses.length;for(var T=0;T<c;T++)for(var d=e.getSubMesh(T),h=d._subIndexBufferStart.length,F=0;F<h;F++)for(var v=d._boneIndicesList[F],_=0;_<v.length;_++){var y=v[_];f[y]||(f[y]=new r.skinnedMatrixCache(T,F,_))}for(var m=0;m<f.length;m++)f[m]||(f[m]=new r.skinnedMatrixCache(0,0,0))}}},{key:"_loadMesh",value:function(e,t){if(e.extras){var a=r.Handler.create(this,glTFUtils._createMesh,null,!1);return glTFUtils.ExecuteExtras("MESH",e.extras,a,[e,t])}return glTFUtils._createMesh(e,t)}},{key:"_createMesh",value:function(e,t){var a=new r.Mesh,l=e.primitives,o=e.weights,s=t?t.joints.length:0,i=[];return l.forEach(function(e){var r=e.mode;null==r&&(r=4),4!=r&&console.warn("glTF Loader: only support gl.TRIANGLES.");var a=[],l=new Map,u=e.attributes,g=glTFUtils.getArrributeBuffer(u.POSITION,"POSITION",l,a),c=glTFUtils.getArrributeBuffer(u.NORMAL,"NORMAL",l,a),f=(glTFUtils.getArrributeBuffer(u.COLOR_0,"COLOR",l,a),glTFUtils.getArrributeBuffer(u.TEXCOORD_0,"UV",l,a),glTFUtils.getArrributeBuffer(u.TEXCOORD_1,"UV1",l,a),glTFUtils.getArrributeBuffer(u.WEIGHTS_0,"BLENDWEIGHT",l,a),glTFUtils.getArrributeBuffer(u.JOINTS_0,"BLENDINDICES",l,a),glTFUtils.getArrributeBuffer(u.TANGENT,"TANGENT",l,a)),T=e.targets;T&&T.forEach(function(e,r){var t=o[r],a=glTFUtils.getBufferwithAccessorIndex(e.POSITION),n=glTFUtils.getBufferwithAccessorIndex(e.NORMAL),l=glTFUtils.getBufferwithAccessorIndex(e.TANGENT);a&&a.forEach(function(e,r){g[r]+=e*t}),n&&n.forEach(function(e,r){c[r]+=e*t}),l&&l.forEach(function(e,r){f[r]+=e*t})});var d=g.length/3,h=glTFUtils.getIndexBuffer(e.indices,d),F=new Array,v=[],_=[];if(t)if(s>glTFUtils.maxSubBoneCount)glTFUtils.splitSubMeshByBonesCount(l,h,F,v,_),d=l.get("POSITION").length/3;else{v[0]=0,_[0]=h.length,F[0]=new Uint16Array(s);for(var y=0;y<s;y++)F[0][y]=y}else v[0]=0,_[0]=h.length;var m=a.toString(),p=new n;i.push(p),p.attributeMap=l,p.indices=h,p.vertexCount=d,p.vertexDecler=m,p.boneIndicesList=F,p.subIndexStartArray=v,p.subIndexCountArray=_}),glTFUtils.parseMeshwithSubMeshData(i,a),glTFUtils.applyglTFSkinData(a,i,t),a}},{key:"calSkinnedSpriteLocalBounds",value:function(e){var t=e.skinnedMeshRenderer,a=e.meshFilter.sharedMesh,n=t.rootBone.transform.worldMatrix,l=new r.Matrix4x4;n.invert(l);var o=a.getIndices(),s=[],i=[],u=[];a.getPositions(s),a.getBoneIndices(i),a.getBoneWeights(u);var g=[];a._subMeshes.forEach(function(e,t){e._boneIndicesList.forEach(function(t,a){for(var n=e._subIndexBufferStart[a],l=e._subIndexBufferCount[a]+n,s=n;s<l;s++){var u=o[s],c=i[u],f=t[c.x],T=t[c.y],d=t[c.z],h=t[c.w];g[u]=new r.Vector4(f,T,d,h)}})});var c=a._inverseBindPoses,f=t.bones,T=[],d=new r.Matrix4x4;f.forEach(function(e,t){T[t]=new r.Matrix4x4,r.Matrix4x4.multiply(l,e.transform.worldMatrix,d),r.Matrix4x4.multiply(d,c[t],T[t])});var h=new r.Matrix4x4,F=new r.Vector3,v=new r.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),_=new r.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);s.forEach(function(e,t){for(var a=g[t],n=u[t],l=0;l<16;l++)h.elements[l]=T[a.x].elements[l]*n.x,h.elements[l]+=T[a.y].elements[l]*n.y,h.elements[l]+=T[a.z].elements[l]*n.z,h.elements[l]+=T[a.w].elements[l]*n.w;r.Vector3.transformV3ToV3(e,h,F),r.Vector3.min(v,F,v),r.Vector3.max(_,F,_)}),s=null,i=u=g=null,o=null,T=null,t.localBounds.setMin(v),t.localBounds.setMax(_)}},{key:"fixSkinnedSprite",value:function(e,r){var t=glTFUtils._glTF.skins[e.skin],a=r.skinnedMeshRenderer;t.joints.forEach(function(e){var r=glTFUtils._glTFNodes[e];a.bones.push(r)}),null==t.skeleton&&(t.skeleton=t.joints[0]),a.rootBone=glTFUtils._glTFNodes[t.skeleton],glTFUtils.calSkinnedSpriteLocalBounds(r)}},{key:"getAnimationRoot",value:function(e){for(var r=function isContainNode(e,r){if(!e)return!1;if(-1==e.indexOf(r))for(var t=0;t<e.length;t++){if(isContainNode(glTFUtils._glTF.nodes[e[t]].children,r))return!0}return!0},t=e[0].target.node,a=0;a<glTFUtils._glTF.scenes.length;a++){if(r(glTFUtils._glTF.scenes[a].nodes,t))return glTFUtils._glTFScenes[a]}return null}},{key:"getAnimationPath",value:function(e,r){var t=[];if(e==r)return t;for(var a=r;a.parent!=e;)a=a.parent,t.push(a.name);return(t=t.reverse()).push(r.name),t}},{key:"_loadAnimations",value:function(e){e&&e.forEach(function(e,r){glTFUtils._loadAnimation(e)})}},{key:"_loadAnimation",value:function(e){return glTFUtils._createAnimator(e)}},{key:"_createAnimator",value:function(e){var t=new r.Animator,a=e.channels,n=e.samplers,o=glTFUtils.getAnimationRoot(a);if(!o)return t;o.addComponentIntance(t);var s=0,i=new Array(a.length);a.forEach(function(e,r){var t=e.target,a=n[e.sampler],u=i[r]=new l,g=glTFUtils._glTFNodes[t.node],c=glTFUtils.getBufferwithAccessorIndex(a.input),f=glTFUtils.getBufferwithAccessorIndex(a.output);switch(u.timeArray=new Float32Array(c),u.valueArray=new Float32Array(f),u.paths=glTFUtils.getAnimationPath(o,g),u.propertyOwner="transform",u.propertyLength=1,u.propertise=[],t.path){case"translation":u.propertise.push("localPosition"),u.type=1;break;case"rotation":u.propertise.push("localRotation"),u.type=2;break;case"scale":u.propertise.push("localScale"),u.type=3}u.duration=u.timeArray[u.timeArray.length-1],s=Math.max(s,u.duration)});var u=e.name?e.name:"Aniamtor",g=new r.AnimatorControllerLayer(u),c=new r.AnimationClip;c.name="clip name",c._duration=s,c.islooping=!0,c._frameRate=30;var f=i.length,T=c._nodes;T.count=f;for(var d=c._nodesMap={},h=c._nodesDic={},F=0;F<f;F++){var v=new r.KeyframeNode,_=i[F];T.setNodeByIndex(F,v),v._indexInList=F;var y=v.type=_.type,m=_.paths.length;v._setOwnerPathCount(m);for(var p=_.paths,x=0;x<m;x++)v._setOwnerPathByIndex(x,p[x]);var U=v._joinOwnerPath("/"),A=d[U];A||(d[U]=A=[]),A.push(v),v.propertyOwner=_.propertyOwner;var L=_.propertyLength;v._setPropertyCount(L);for(var M=0;M<L;M++)v._setPropertyByIndex(M,_.propertise[M]);var w=U+"."+v.propertyOwner+"."+v._joinProperty(".");h[w]=w,v.fullPath=w;for(var E=_.timeArray.length,B=0;B<E;B++)switch(y){case 0:break;case 1:case 3:case 4:var b=new r.Vector3Keyframe;v._setKeyframeByIndex(B,b);b.time=_.timeArray[B];var k=b.inTangent,S=b.outTangent,C=b.value;k.setValue(0,0,0),S.setValue(0,0,0),C.setValue(_.valueArray[3*B],_.valueArray[3*B+1],_.valueArray[3*B+2]);break;case 2:var I=new r.QuaternionKeyframe;v._setKeyframeByIndex(B,I);I.time=_.timeArray[B];var N=I.inTangent,R=I.outTangent,D=I.value;N.setValue(0,0,0,0),R.setValue(0,0,0,0),D.x=_.valueArray[4*B],D.y=_.valueArray[4*B+1],D.z=_.valueArray[4*B+2],D.w=_.valueArray[4*B+3]}}var P=new r.AnimatorState;return P.name="state name",P.clip=c,g.addState(P),g.defaultState=P,g.playOnWake=!0,t.addControllerLayer(g),g.defaultWeight=1,t}}]),glTFUtils}();o.NAMEID=0,o.maxSubBoneCount=24,o.Extensions={},o.Extras={},o._glTFBuffers=[],o._glTFTextures=[],o._glTFMaterials=[],o._glTFNodes=[],o._glTFScenes=[];var s=function(){function glTFLoader(){_classCallCheck(this,glTFLoader)}return _createClass(glTFLoader,null,[{key:"init",value:function(){r.LoaderManager.createMap.gltf=[glTFLoader.GLTF,o._parse];var e=r.Loader.parserMap;e[glTFLoader.GLTF]=glTFLoader._loadglTF,e[glTFLoader.GLTFBASE64TEX]=glTFLoader._loadBase64Texture,glTFLoader._innerBufferLoaderManager.on(r.Event.ERROR,null,glTFLoader._eventLoadManagerError),glTFLoader._innerTextureLoaderManager.on(r.Event.ERROR,null,glTFLoader._eventLoadManagerError)}},{key:"_loadglTF",value:function(e){e._originType=e.type,e.on(r.Event.LOADED,null,glTFLoader._onglTFLoaded,[e]),e.load(e.url,r.Loader.JSON,!1,null,!0)}},{key:"_loadBase64Texture",value:function(e){var t=e.url;e.on(r.Event.LOADED,null,function(t){e._cache=e._createCache;var a=r.Texture2D._parse(t,e._propertyParams,e._constructParams);glTFLoader._endLoad(e,a)}),e.load(t,"nativeimage",!1,null,!0)}},{key:"formatRelativePath",value:function(e,r){var t;if(t=e+r,"."===r.charAt(0)){for(var a=t.split("/"),n=0,l=a.length;n<l;n++)if(".."==a[n]){var o=n-1;o>0&&".."!==a[o]&&(a.splice(o,2),n-=2)}t=a.join("/")}return t}},{key:"_addglTFInnerUrls",value:function(e,r,t,a,n,l){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,i=glTFLoader.formatRelativePath(a,n);return t&&(i+=t),e.push({url:i,type:l,constructParams:o,propertyParams:s}),r&&r.push(i),i}},{key:"_getglTFInnerUrlsCount",value:function(e){var r=0;return e.buffers&&e.buffers.forEach(function(e){t.isBase64String(e.uri)||r++}),e.textures&&(r+=e.textures.length),r}},{key:"_getglTFBufferUrls",value:function(e,a,n,l){e.buffers&&e.buffers.forEach(function(e){if(t.isBase64String(e.uri)){var o=t.decode(e.uri.replace(t.reghead,""));r.Loader.cacheRes(e.uri,o)}else e.uri=glTFLoader._addglTFInnerUrls(a,null,n,l,e.uri,r.Loader.BUFFER)})}},{key:"_getglTFTextureUrls",value:function(e,a,n,l,s){e.textures&&e.textures.forEach(function(i){var u=e.images[i.source],g=e.samplers?e.samplers[i.sampler]:void 0,c=o.getTextureConstructParams(u,g),f=o.getTexturePropertyParams(g);if(null!=u.bufferView||null!=u.bufferView){var T=e.bufferViews[u.bufferView],d=e.buffers[T.buffer],h=r.Loader.getRes(d.uri),F=T.byteOffset||0,v=T.byteLength,_=h.slice(F,F+v),y=t.encode(_),m="data:".concat(u.mimeType,";base64,").concat(y);u.uri=glTFLoader._addglTFInnerUrls(a,n,l,"",m,glTFLoader.GLTFBASE64TEX,c,f)}else t.isBase64String(u.uri)?u.uri=glTFLoader._addglTFInnerUrls(a,n,l,"",u.uri,glTFLoader.GLTFBASE64TEX,c,f):u.uri=glTFLoader._addglTFInnerUrls(a,n,l,s,u.uri,r.Loader.TEXTURE2D,c,f)})}},{key:"_onglTFLoaded",value:function(e,t){var a=e.url,n=r.Utils3D.getURLVerion(a),l=r.URL.getPath(a),o=[];glTFLoader._getglTFBufferUrls(t,o,n,l);var s=glTFLoader._getglTFInnerUrlsCount(t),i=s+1,u=1/i;glTFLoader._onProcessChange(e,0,u,1);var g=s/i;if(o.length>0){var c=r.Handler.create(null,glTFLoader._onProcessChange,[e,u,g],!1);glTFLoader._innerBufferLoaderManager._create(o,!1,r.Handler.create(null,glTFLoader._onglTFBufferResourceLoaded,[e,c,t,n,l,u+g*o.length,g]),c,null,null,null,1,!0)}else glTFLoader._onglTFBufferResourceLoaded(e,null,t,n,l,u,g)}},{key:"_onglTFBufferResourceLoaded",value:function(e,t,a,n,l,o,s){t&&t.recover();var i=[],u=[];if(glTFLoader._getglTFTextureUrls(a,i,u,n,l),i.length>0){var g=r.Handler.create(null,glTFLoader._onProcessChange,[e,o,s],!1);glTFLoader._innerTextureLoaderManager._create(i,!1,r.Handler.create(null,glTFLoader._onglTFTextureResourceLoaded,[e,g,a,u]),t,null,null,null,1,!0)}else glTFLoader._onglTFTextureResourceLoaded(e,t,a,u)}},{key:"_onglTFTextureResourceLoaded",value:function(e,r,t,a){r&&r.recover(),e._cache=e._createCache;var n=o._parse(t,e._propertyParams,e._constructParams);glTFLoader._endLoad(e,n,a)}},{key:"_eventLoadManagerError",value:function(e){r.Laya.loader.event(r.Event.ERROR,e)}},{key:"_onProcessChange",value:function(e,t,a,n){(n=t+n*a)<1&&e.event(r.Event.PROGRESS,2*n/3+1/3)}},{key:"_endLoad",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(a)for(var n=0;n<a.length;n++){var l=r.Loader.getRes(a[n]);l&&l._removeReference()}e.endLoad(t)}}]),glTFLoader}();s.GLTF="GLTF",s.GLTFBASE64TEX="GLTFBASE64TEX",s._innerBufferLoaderManager=new r.LoaderManager,s._innerTextureLoaderManager=new r.LoaderManager,e.glTFBase64Tool=t,e.glTFLoader=s,e.glTFTextureEditor=a,e.glTFUtils=o}(window.Laya=window.Laya||{},Laya);