"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var r=_superPropBase(t,e);if(r){var a=Object.getOwnPropertyDescriptor(r,e);return a.get?a.get.call(i):a.value}})(t,e,i||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(t){var e=_isNativeReflectConstruct();return function(){var i,r=_getPrototypeOf(t);if(e){var a=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,a)}else i=r.apply(this,arguments);return _possibleConstructorReturn(this,i)}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}!function(t,e){var i=function(){function ParticleSetting(){_classCallCheck(this,ParticleSetting),this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.emitterVelocitySensitivity=1,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.gravity=new Float32Array([0,0,0]),this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalStartRadian=0,this.maxHorizontalStartRadian=0,this.minVerticalStartRadian=0,this.maxVerticalStartRadian=0,this.useEndRadian=!0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.minStartColor=new Float32Array([1,1,1,1]),this.maxStartColor=new Float32Array([1,1,1,1]),this.minEndColor=new Float32Array([1,1,1,1]),this.maxEndColor=new Float32Array([1,1,1,1]),this.colorComponentInter=!1,this.disableColor=!1,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.positionVariance=new Float32Array([0,0,0])}return _createClass(ParticleSetting,null,[{key:"checkSetting",value:function(t){var e;for(e in ParticleSetting._defaultSetting)e in t||(t[e]=ParticleSetting._defaultSetting[e]);t.endVelocity=+t.endVelocity,t.gravity[0]=+t.gravity[0],t.gravity[1]=+t.gravity[1],t.gravity[2]=+t.gravity[2]}}]),ParticleSetting}();i._defaultSetting=new i;var r=function(){function ParticleTemplateBase(){_classCallCheck(this,ParticleTemplateBase)}return _createClass(ParticleTemplateBase,[{key:"addParticleArray",value:function(t,e){}}]),ParticleTemplateBase}(),a=function(){function ParticleData(){_classCallCheck(this,ParticleData)}return _createClass(ParticleData,null,[{key:"Create",value:function(t,i,r,a){var n=new ParticleData;n.position=i,e.MathUtil.scaleVector3(r,t.emitterVelocitySensitivity,ParticleData._tempVelocity);var o,s=e.MathUtil.lerp(t.minHorizontalVelocity,t.maxHorizontalVelocity,Math.random()),l=Math.random()*Math.PI*2;if(ParticleData._tempVelocity[0]+=s*Math.cos(l),ParticleData._tempVelocity[2]+=s*Math.sin(l),ParticleData._tempVelocity[1]+=e.MathUtil.lerp(t.minVerticalVelocity,t.maxVerticalVelocity,Math.random()),n.velocity=ParticleData._tempVelocity,n.startColor=ParticleData._tempStartColor,n.endColor=ParticleData._tempEndColor,t.disableColor){for(o=0;o<3;o++)n.startColor[o]=1,n.endColor[o]=1;n.startColor[o]=e.MathUtil.lerp(t.minStartColor[o],t.maxStartColor[o],Math.random()),n.endColor[o]=e.MathUtil.lerp(t.minEndColor[o],t.maxEndColor[o],Math.random())}else if(t.colorComponentInter)for(o=0;o<4;o++)n.startColor[o]=e.MathUtil.lerp(t.minStartColor[o],t.maxStartColor[o],Math.random()),n.endColor[o]=e.MathUtil.lerp(t.minEndColor[o],t.maxEndColor[o],Math.random());else e.MathUtil.lerpVector4(t.minStartColor,t.maxStartColor,Math.random(),n.startColor),e.MathUtil.lerpVector4(t.minEndColor,t.maxEndColor,Math.random(),n.endColor);n.sizeRotation=ParticleData._tempSizeRotation;var c=Math.random();n.sizeRotation[0]=e.MathUtil.lerp(t.minStartSize,t.maxStartSize,c),n.sizeRotation[1]=e.MathUtil.lerp(t.minEndSize,t.maxEndSize,c),n.sizeRotation[2]=e.MathUtil.lerp(t.minRotateSpeed,t.maxRotateSpeed,Math.random()),n.radius=ParticleData._tempRadius;var h=Math.random();n.radius[0]=e.MathUtil.lerp(t.minStartRadius,t.maxStartRadius,h),n.radius[1]=e.MathUtil.lerp(t.minEndRadius,t.maxEndRadius,h),n.radian=ParticleData._tempRadian,n.radian[0]=e.MathUtil.lerp(t.minHorizontalStartRadian,t.maxHorizontalStartRadian,Math.random()),n.radian[1]=e.MathUtil.lerp(t.minVerticalStartRadian,t.maxVerticalStartRadian,Math.random());var m=t.useEndRadian;return n.radian[2]=m?e.MathUtil.lerp(t.minHorizontalEndRadian,t.maxHorizontalEndRadian,Math.random()):n.radian[0],n.radian[3]=m?e.MathUtil.lerp(t.minVerticalEndRadian,t.maxVerticalEndRadian,Math.random()):n.radian[1],n.durationAddScale=t.ageAddScale*Math.random(),n.time=a,n}}]),ParticleData}();a._tempVelocity=new Float32Array(3),a._tempStartColor=new Float32Array(4),a._tempEndColor=new Float32Array(4),a._tempSizeRotation=new Float32Array(3),a._tempRadius=new Float32Array(2),a._tempRadian=new Float32Array(4);var n=function(t){_inherits(ParticleTemplateWebGL,r);var e=_createSuper(ParticleTemplateWebGL);function ParticleTemplateWebGL(t){var i;return _classCallCheck(this,ParticleTemplateWebGL),(i=e.call(this))._floatCountPerVertex=29,i._firstActiveElement=0,i._firstNewElement=0,i._firstFreeElement=0,i._firstRetiredElement=0,i._currentTime=0,i.settings=t,i}return _createClass(ParticleTemplateWebGL,[{key:"reUse",value:function(t,e){return 0}},{key:"initialize",value:function(){var t;this._vertices=this._mesh._vb.getFloat32Array(),t=this._mesh._stride/4;for(var e=0,i=0,r=0;r<this.settings.maxPartices;r++){var a,n=Math.random(),o=this.settings.textureCount?1/this.settings.textureCount:1;for(a=0;a<this.settings.textureCount&&!(n<a+o);a+=o);this._vertices[e++]=-1,this._vertices[e++]=-1,this._vertices[e++]=0,this._vertices[e++]=a,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=a,e=i+=t,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=1,this._vertices[e++]=a+o,e=i+=t,this._vertices[e++]=-1,this._vertices[e++]=1,this._vertices[e++]=0,this._vertices[e++]=a+o,e=i+=t}}},{key:"update",value:function(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)}},{key:"retireActiveParticles",value:function(){for(var t=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*4,i=e+28,r=this._currentTime-this._vertices[i];if((r*=1+this._vertices[e+27])+1e-4<t)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}}},{key:"freeRetiredParticles",value:function(){for(;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+28]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}}},{key:"addNewParticlesToVertexBuffer",value:function(){}},{key:"addParticleArray",value:function(t,e){var i=this._firstFreeElement+1;if(i>=this.settings.maxPartices&&(i=0),i!==this._firstRetiredElement){for(var r=a.Create(this.settings,t,e,this._currentTime),n=this._firstFreeElement*this._floatCountPerVertex*4,o=0;o<4;o++){var s,l;for(s=0,l=4;s<3;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.position[s];for(s=0,l=7;s<3;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.velocity[s];for(s=0,l=10;s<4;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.startColor[s];for(s=0,l=14;s<4;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.endColor[s];for(s=0,l=18;s<3;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.sizeRotation[s];for(s=0,l=21;s<2;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.radius[s];for(s=0,l=23;s<4;s++)this._vertices[n+o*this._floatCountPerVertex+l+s]=r.radian[s];this._vertices[n+o*this._floatCountPerVertex+27]=r.durationAddScale,this._vertices[n+o*this._floatCountPerVertex+28]=r.time}this._firstFreeElement=i}}}]),ParticleTemplateWebGL}(),o="attribute vec4 a_CornerTextureCoordinate;\nattribute vec3 a_Position;\nattribute vec3 a_Velocity;\nattribute vec4 a_StartColor;\nattribute vec4 a_EndColor;\nattribute vec3 a_SizeRotation;\nattribute vec2 a_Radius;\nattribute vec4 a_Radian;\nattribute float a_AgeAddScale;\nattribute float a_Time;\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\n\nuniform float u_CurrentTime;\nuniform float u_Duration;\nuniform float u_EndVelocity;\nuniform vec3 u_Gravity;\n\nuniform vec2 size;\nuniform mat4 u_mmat;\n\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\n{\n\n   float startVelocity = length(velocity);//起始标量速度\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\n\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\n   \n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\n   \n   float radius=mix(a_Radius.x, a_Radius.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\n   float radianHorizontal =mix(a_Radian.x,a_Radian.z,normalizedAge);\n   float radianVertical =mix(a_Radian.y,a_Radian.w,normalizedAge);\n   \n   float r =cos(radianVertical)* radius;\n   addPosition.y += sin(radianVertical) * radius;\n\t\n   addPosition.x += cos(radianHorizontal) *r;\n   addPosition.z += sin(radianHorizontal) *r;\n  \n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\n   position+=addPosition;\n   return  vec4(position,1.0);\n}\n\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\n{    \n    float size = mix(startSize, endSize, normalizedAge);\n    return size;\n}\n\nmat2 ComputeParticleRotation(in float rot,in float age)\n{    \n    float rotation =rot * age;\n    //计算2x2旋转矩阵.\n    float c = cos(rotation);\n    float s = sin(rotation);\n    return mat2(c, -s, s, c);\n}\n\nvec4 ComputeParticleColor(in vec4 startColor,in vec4 endColor,in float normalizedAge)\n{\n\tvec4 color=mix(startColor,endColor,normalizedAge);\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\n   \n    return color;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_Time;\n   age *= 1.0 + a_AgeAddScale;\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\n\t\n    mat4 mat=u_mmat;\n    gl_Position=vec4((mat*gl_Position).xy,0.0,1.0);\n    gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize*vec2(mat[0][0],mat[1][1]);\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\n   \n   v_Color = ComputeParticleColor(a_StartColor,a_EndColor, normalizedAge);\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\n}\n\n",s="#if defined(GL_FRAGMENT_PRECISION_HIGH)\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec4 v_Color;\r\nvarying vec2 v_TextureCoordinate;\r\nuniform sampler2D u_texture;\r\n\r\nvoid main()\r\n{\t\r\n\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\r\n\tgl_FragColor.xyz *= v_Color.w;\r\n}",l=function(t){_inherits(ParticleShader,e.Shader);var i=_createSuper(ParticleShader);function ParticleShader(){return _classCallCheck(this,ParticleShader),i.call(this,o,s,"ParticleShader",null,["a_CornerTextureCoordinate",0,"a_Position",1,"a_Velocity",2,"a_StartColor",3,"a_EndColor",4,"a_SizeRotation",5,"a_Radius",6,"a_Radian",7,"a_AgeAddScale",8,"a_Time",9])}return ParticleShader}();l.vs=o,l.ps=s;var c=function(t){_inherits(ParticleShaderValue,e.Value2D);var i=_createSuper(ParticleShaderValue);function ParticleShaderValue(){var t;return _classCallCheck(this,ParticleShaderValue),t=i.call(this,0,0),ParticleShaderValue.pShader||(ParticleShaderValue.pShader=new l),t}return _createClass(ParticleShaderValue,[{key:"upload",value:function(){var t=this.size;t[0]=e.RenderState2D.width,t[1]=e.RenderState2D.height,this.alpha=this.ALPHA*e.RenderState2D.worldAlpha,ParticleShaderValue.pShader.upload(this)}}]),ParticleShaderValue}();c.pShader=null;var h=function(t){_inherits(ParticleTemplate2D,n);var i=_createSuper(ParticleTemplate2D);function ParticleTemplate2D(t){var r;_classCallCheck(this,ParticleTemplate2D),(r=i.call(this,t)).x=0,r.y=0,r.sv=new c,r._key={};var a=_assertThisInitialized(r);return e.ILaya.loader.load(r.settings.textureName,e.Handler.create(null,function(t){a.texture=t}),null,e.Loader.IMAGE),r.sv.u_Duration=r.settings.duration,r.sv.u_Gravity=r.settings.gravity,r.sv.u_EndVelocity=r.settings.endVelocity,r._blendFn=e.BlendMode.fns[t.blendState],r._mesh=e.MeshParticle2D.getAMesh(r.settings.maxPartices),r.initialize(),r}return _createClass(ParticleTemplate2D,[{key:"getRenderType",value:function(){return-111}},{key:"releaseRender",value:function(){}},{key:"addParticleArray",value:function(t,e){t[0]+=this.x,t[1]+=this.y,_get(_getPrototypeOf(ParticleTemplate2D.prototype),"addParticleArray",this).call(this,t,e)}},{key:"addNewParticlesToVertexBuffer",value:function(){var t,e=this._mesh._vb;e.clear(),e.append(this._vertices),this._firstNewElement<this._firstFreeElement?(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.subUpload(t,t,t+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(t=4*this._firstNewElement*this._floatCountPerVertex*4,e.subUpload(t,t,t+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(e.setNeedUpload(),e.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement}},{key:"renderSubmit",value:function(){if(this.texture&&this.texture.getIsReady()){if(this.update(e.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement){var t=e.WebGLContext.mainContext;this._mesh.useMesh(t),this.sv.u_texture=this.texture._getSource(),this.sv.upload(),this._firstActiveElement<this._firstFreeElement?t.drawElements(t.TRIANGLES,6*(this._firstFreeElement-this._firstActiveElement),t.UNSIGNED_SHORT,6*this._firstActiveElement*2):(e.WebGLContext.mainContext.drawElements(t.TRIANGLES,6*(this.settings.maxPartices-this._firstActiveElement),t.UNSIGNED_SHORT,6*this._firstActiveElement*2),this._firstFreeElement>0&&t.drawElements(t.TRIANGLES,6*this._firstFreeElement,t.UNSIGNED_SHORT,0)),e.Stat.renderBatches++}this._drawCounter++}return 1}},{key:"updateParticleForNative",value:function(){this.texture&&this.texture.getIsReady()&&(this.update(e.ILaya.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&(this._firstNewElement=this._firstFreeElement))}},{key:"getMesh",value:function(){return this._mesh}},{key:"getConchMesh",value:function(){return this._conchMesh}},{key:"getFirstNewElement",value:function(){return this._firstNewElement}},{key:"getFirstFreeElement",value:function(){return this._firstFreeElement}},{key:"getFirstActiveElement",value:function(){return this._firstActiveElement}},{key:"getFirstRetiredElement",value:function(){return this._firstRetiredElement}},{key:"setFirstFreeElement",value:function(t){this._firstFreeElement=t}},{key:"setFirstNewElement",value:function(t){this._firstNewElement=t}},{key:"addDrawCounter",value:function(){this._drawCounter++}},{key:"blend",value:function(){if(e.BlendMode.activeBlendFunction!==this._blendFn){var t=e.WebGLContext.mainContext;t.enable(t.BLEND),this._blendFn(t),e.BlendMode.activeBlendFunction=this._blendFn}}},{key:"dispose",value:function(){this._mesh.releaseMesh()}}]),ParticleTemplate2D}();h.activeBlendType=-1;var m=function(){function EmitterBase(){_classCallCheck(this,EmitterBase),this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60}return _createClass(EmitterBase,[{key:"start",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.MAX_VALUE;0!=this._emissionRate&&(this._emissionTime=t)}},{key:"stop",value:function(){this._emissionTime=0}},{key:"clear",value:function(){this._emissionTime=0}},{key:"emit",value:function(){}},{key:"advanceTime",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()}},{key:"particleTemplate",set:function(t){this._particleTemplate=t}},{key:"emissionRate",set:function(t){t<=0||(this._emissionRate=t,t>0&&(this.minEmissionTime=1/t))},get:function(){return this._emissionRate}}]),EmitterBase}(),u=function(t){_inherits(Emitter2D,m);var e=_createSuper(Emitter2D);function Emitter2D(t){var i;return _classCallCheck(this,Emitter2D),(i=e.call(this)).template=t,i}return _createClass(Emitter2D,[{key:"emit",value:function(){_get(_getPrototypeOf(Emitter2D.prototype),"emit",this).call(this),null!=this._emitFun&&this._emitFun()}},{key:"getRandom",value:function(t){return(2*Math.random()-1)*t}},{key:"webGLEmit",value:function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)}},{key:"canvasEmit",value:function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)}},{key:"template",set:function(t){this._particleTemplate=t,t||(this._emitFun=null,this.setting=null,this._posRange=null),this.setting=t.settings,this._posRange=this.setting.positionVariance,this._particleTemplate instanceof h&&(this._emitFun=this.webGLEmit)},get:function(){return this._particleTemplate}}]),Emitter2D}(),_=function(t){_inherits(Particle2D,e.Sprite);var r=_createSuper(Particle2D);function Particle2D(t){var e;return _classCallCheck(this,Particle2D),(e=r.call(this))._matrix4=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),e.autoPlay=!0,e.customRenderEnable=!0,t&&e.setParticleSetting(t),e}return _createClass(Particle2D,[{key:"load",value:function(t){e.ILaya.loader.load(t,e.Handler.create(this,this.setParticleSetting),null,e.ILaya.Loader.JSON)}},{key:"setParticleSetting",value:function(t){if(!t)return this.stop();i.checkSetting(t),this.customRenderEnable=!0,this._particleTemplate=new h(t),this.graphics._saveToCmd(null,e.DrawParticleCmd.create(this._particleTemplate)),this._emitter?this._emitter.template=this._particleTemplate:this._emitter=new u(this._particleTemplate),this.autoPlay&&(this.emitter.start(),this.play())}},{key:"play",value:function(){e.ILaya.timer.frameLoop(1,this,this._loop)}},{key:"stop",value:function(){e.ILaya.timer.clear(this,this._loop)}},{key:"_loop",value:function(){this.advanceTime(1/60)}},{key:"advanceTime",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)}},{key:"customRender",value:function(t,e,i){this._matrix4[0]=t._curMat.a,this._matrix4[1]=t._curMat.b,this._matrix4[4]=t._curMat.c,this._matrix4[5]=t._curMat.d,this._matrix4[12]=t._curMat.tx,this._matrix4[13]=t._curMat.ty,this._particleTemplate.sv.u_mmat=this._matrix4,this._canvasTemplate&&this._canvasTemplate.render(t,e,i)}},{key:"destroy",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._particleTemplate instanceof h&&this._particleTemplate.dispose(),_get(_getPrototypeOf(Particle2D.prototype),"destroy",this).call(this,t)}},{key:"url",set:function(t){this.load(t)}},{key:"emitter",get:function(){return this._emitter}}]),Particle2D}();e.ClassUtils.regClass("laya.particle.Particle2D",_),e.ClassUtils.regClass("Laya.Particle2D",_),e.ILaya.regClass(_);var d=function(){function ParticleEmitter(t,e,i){_classCallCheck(this,ParticleEmitter),this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=t,this._timeBetweenParticles=1/e,this._previousPosition=i}return _createClass(ParticleEmitter,[{key:"update",value:function(t,i){if((t/=1e3)>0){e.MathUtil.subtractVector3(i,this._previousPosition,this._tempVelocity),e.MathUtil.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var r=this._timeLeftOver+t,a=-this._timeLeftOver;r>this._timeBetweenParticles;)a+=this._timeBetweenParticles,r-=this._timeBetweenParticles,e.MathUtil.lerpVector3(this._previousPosition,i,a/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=r}this._previousPosition[0]=i[0],this._previousPosition[1]=i[1],this._previousPosition[2]=i[2]}}]),ParticleEmitter}();t.Emitter2D=u,t.EmitterBase=m,t.Particle2D=_,t.ParticleData=a,t.ParticleEmitter=d,t.ParticleSetting=i,t.ParticleShader=l,t.ParticleShaderValue=c,t.ParticleTemplate2D=h,t.ParticleTemplateBase=r,t.ParticleTemplateWebGL=n}(window.Laya=window.Laya||{},Laya);