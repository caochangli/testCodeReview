"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}!function(e,t){var a={autoRetryConnnect:!0,retryConnnectCount:0,retryConnnectDelay:1e4},n=window.WebSocket,r=function(){function SocketManager(e,t,r,o,i){var s=this;_classCallCheck(this,SocketManager),this.clientId=0,this.socket=null,this.isSupport=!1,this.status=0,this.retryConnnectCount=0,this.onClose=function(e){var t=s.options,a=t.onClose,n=t.autoRetryConnnect,r=t.retryConnnectCount;r=r||0,a&&a(e),0===s.status&&n&&(0==r||s.retryConnnectCount<r)&&s.delayRetryConnnect()},this._delayRetryConnnectTimer=0,this._delayRetryConnnect=function(){clearTimeout(s._delayRetryConnnectTimer),s.retryConnnectCount++,s.reConnect()},this.onMessage=function(e){var t=s.options.onMessage;t&&t(e)},this.onError=function(e){var t=s.options.onError;t&&t(e)},this.onOpen=function(e){var t=s.options.onOpen;t&&t(e),s.retryConnnectCount=0,clearTimeout(s._delayRetryConnnectTimer)},this.url="ws://"+e+":"+t+"?type="+o+"&name="+r,i?(Object.assign(i,a),this.options=i):this.options=a,n=window.WebSocket,this.isSupport=void 0!==n,this.isSupport?this.reConnect():console.log("not support websocket")}return _createClass(SocketManager,[{key:"closeConnect",value:function(){if(this.retryConnnectCount=0,this.socket){var e=this.socket;e.onclose=null,e.onmessage=null,e.onerror=null,e.onopen=null,e.close(),this.socket=null}this.status=0}},{key:"delayRetryConnnect",value:function(){clearTimeout(this._delayRetryConnnectTimer),i.enable&&(this._delayRetryConnnectTimer=setTimeout(this._delayRetryConnnect,this.options.retryConnnectDelay))}},{key:"reConnect",value:function(){var e=new n(this.url);this.socket=e,e.onclose=this.onClose,e.onmessage=this.onMessage,e.onerror=this.onError,e.onopen=this.onOpen}},{key:"dispose",value:function(){this.closeConnect()}},{key:"send",value:function(e){return!(!this.socket||1!==this.socket.readyState)&&(this.socket.send(e),!0)}}]),SocketManager}(),o=function(e,t){e=e.replace(/[\[\]]/g,"\\$&");var a=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return a?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null},i=function(){function ProfileHelper(){var e=this;_classCallCheck(this,ProfileHelper),this.socketManager=null,this.selectPlayerId=0,this.active=0,this.selectPlayerStatus=0,this.sendMsg=function(t,a){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e.socketManager.send(JSON.stringify({type:t,data:a,toId:n}))},this.sendInternalMsg=function(t,a){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e.socketManager.send(JSON.stringify({type:t,data:a,toId:n}))},this.frameDataList=[],this.sendFramData=function(t){e.active&&(e.frameDataList.push(t),e.frameDataList.length>=30&&(e.sendFramDataList(e.frameDataList),e.frameDataList.length=0))},this.sendConfigData=function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var t=e.performanceDataTool.getPathInfo();e.sendInternalMsg("getPerformanceConf_back",t)},this.sendFramDataList=function(t){var a=t.map(function(e){return{type:"frameData",data:e}});e.sendInternalMsg("msgList",a)}}return _createClass(ProfileHelper,[{key:"init",value:function(e,t,n,i,s,l){var h=this;if(this.frameDataList=[],"player"===e&&!t)throw new Error("type为player时，performanceDataTool不为空");var c="",f="",d="";window&&window.location&&window.location.href&&(d=window.location.href);var P=o("profileName",d)||"",_=o("profilePort",d)||"1050";if(ProfileHelper.Host||o("profileHost",d))c=ProfileHelper.Host||o("profileHost",d);else if(d.startsWith("http")){var u=d.indexOf("//"),D=d.indexOf("/",u+3);-1===D&&(D=d.length),(D=(f=d.substring(u+2,D)).indexOf(":"))>=0&&(f=f.substring(0,D)),c=f}else c="localhost";this.performanceDataTool=t,this.heartIntervalHandler=setInterval(function(){h.sendInternalMsg("heart",{})},1e4),this.socketManager=new r(c,_,P,e,{retryConnectCount:s||a.retryConnnectCount,retryConnnectDelay:l||a.retryConnnectDelay,onMessage:function(e){if(h.socketManager&&"string"==typeof e.data){var t=JSON.parse(e.data),a=[t];"msgList"===t.type&&(a=t.data),a.forEach(function(e){switch(e.type){case"onSelectMe":h.sendInternalMsg("onSelectMe_back",e.data);break;case"getPerformanceConf":h.sendConfigData();break;case"selectPlayer_back":h.selectPlayerId=e.data.selectPlayer,h.selectPlayerStatus=0;break;case"onReady":h.socketManager.clientId=e.data.id,h.sendInternalMsg("start",{});break;case"active":h.active=e.data.active;break;case"playerList":if(h.selectPlayerId&&(function(e,t){for(var a=0;a<t.length;a++)if(t[a].id==e)return!0;return!1}(h.selectPlayerId,e.data)||(h.selectPlayerId=0,h.selectPlayerStatus=0)),h.selectPlayerId&&e.data.length>0&&0==h.selectPlayerStatus){var t=e.data[0].id;h.selectPlayerStatus=1,h.sendMsg("selectPlayer",{id:t})}}}),i&&a.forEach(function(e){i(e)})}},onOpen:function(e){n&&n(e)},onError:function(e){},onClose:function(e){}})}},{key:"dispose",value:function(){clearInterval(this.heartIntervalHandler),this.socketManager&&(this.socketManager.dispose(),this.socketManager=null),this.performanceDataTool=null}}],[{key:"init",value:function(e,t,a,n,r,o){ProfileHelper.instance&&ProfileHelper.instance.dispose(),ProfileHelper.initOption={type:e,performanceDataTool:t,onOpen:a,onMessage:n,retryConnectCount:r,retryConnnectDelay:o},ProfileHelper._enable&&(ProfileHelper.instance=new ProfileHelper,ProfileHelper.instance.init(e,t,a,n,r,o))}},{key:"enable",set:function(e){if(ProfileHelper._enable!==e)if(ProfileHelper._enable=e,e){var t=ProfileHelper.initOption;if(!t)throw new Error("没有执行初始化init");var a=t.type,n=t.performanceDataTool,r=t.onOpen,o=t.onMessage,i=t.retryConnectCount,s=t.retryConnnectDelay;ProfileHelper.init(a,n,r,o,i,s)}else ProfileHelper.dispose()},get:function(){return ProfileHelper._enable}}]),ProfileHelper}();i.sendFramData=function(e){i._enable&&i.instance&&i.instance.sendFramData(e)},i.sendConfigData=function(e){i._enable&&i.instance&&i.instance.sendConfigData(e)},i.dispose=function(){i.instance&&i.instance.dispose(),i.instance=null};var s=function(){function PerformanceDataTool(){_classCallCheck(this,PerformanceDataTool),this._enable=!1,this._AllPathMap={},this._pathColor={},this._pathCount=0,this._runtimeShowPathIndex=-1,this._nodeList=[],this.samplerFramStep=6,this._memoryDataMap={},this.pointArray=[],this.fpsArray=[]}return _createClass(PerformanceDataTool,[{key:"InitLayaPerformanceInfo",value:function(){this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_2D,[255,128,128,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D,[255,255,128,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER,[128,255,128,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_UPDATESCRIPT,[128,255,255,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_PHYSICS,[0,128,255,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_PHYSICS_SIMULATE,[255,0,0,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_PHYSICS_CHARACTORCOLLISION,[255,128,0,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_PHYSICS_EVENTSCRIPTS,[128,0,0,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER,[64,128,128,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_SHADOWMAP,[192,192,192,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_CLUSTER,[128,64,64,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_CULLING,[0,64,128,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_RENDERDEPTHMDOE,[128,0,64,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_RENDEROPAQUE,[128,0,255,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_RENDERCOMMANDBUFFER,[128,128,64,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_RENDERTRANSPARENT,[128,0,255,255]),this.setPathDataColor(PerformanceDataTool.PERFORMANCE_LAYA_3D_RENDER_POSTPROCESS,[0,255,0,255])}},{key:"getNodePathIndex",value:function(e){var t;return null!=this._AllPathMap[e]?t=this._AllPathMap[e]:(t=this._pathCount++,this._AllPathMap[e]=t,i.sendConfigData(this.getPathInfo())),t}},{key:"getPathInfo",value:function(){var e={};return 0==Object.keys(this._pathColor).length&&this.InitLayaPerformanceInfo(),e._pathColor=this._pathColor,e._AllPathMap=this._AllPathMap,e}},{key:"exportPerformanceFile",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];PerformanceDataTool.InitLayaPerformanceInfo(),e||(this.enable=!1);var a,n,r,o=[],i=[],s=[],l=0,h=new t.Byte;h.pos=0,h.writeUTFString(PerformanceDataTool.VERSION),o.push("DataInfo01","Color","NodeInfo"),h.writeUint16(o.length);for(var c=0;c<o.length;c++)h.writeUTFString(o[c]);i.length=o.length,s.length=o.length,a=h.pos;for(var f=0;f<o.length;f++)h.writeInt32(0),h.writeInt32(0);for(var d in i[0]=h.pos,h.writeInt32(this._nodeList.length),h.writeInt32(this.samplerFramStep),h.writeInt32(this._pathCount),this._AllPathMap)h.writeUTFString(d);for(var P in n=h.pos,h.writeInt32(0),this._memoryDataMap)h.writeUTFString(P),l++;for(var _ in r=h.pos,h.pos=n,h.writeInt32(l),h.pos=r,s[0]=h.pos-i[0],i[1]=h.pos,n=h.pos,l=0,h.writeInt32(0),this._pathColor){var u=this._pathColor[_];h.writeUTFString(_),h.writeUint32(u[0]),h.writeUint32(u[1]),h.writeUint32(u[2]),h.writeUint32(u[3]),l++}r=h.pos,h.pos=n,h.writeInt32(l),h.pos=r,s[1]=h.pos-i[1],i[2]=h.pos;for(var D=0;D<this._nodeList.length;D++){var p=this._nodeList[D];h.writeInt32(p.nodeNum);for(var R=0;R<p.nodeNum;R++)h.writeFloat32(p.nodeDelty[R]?p.nodeDelty[R]:0)}s[2]=h.pos-i[2],h.pos=a;for(var E=0;E<o.length;E++)h.writeInt32(i[E]),h.writeInt32(s[E]);return h}},{key:"BegainSample",value:function(e){this.enable&&(this.update(),this._runtimeNode.getFunStart(this.getNodePathIndex(e)))}},{key:"EndSample",value:function(e){return this.enable?this._runtimeNode.getFunEnd(this.getNodePathIndex(e)):0}},{key:"AddMemory",value:function(e,t){this._memoryDataMap[e]=this._memoryDataMap[e]?this._memoryDataMap[e]+t:t}},{key:"setPathDataColor",value:function(e,t){this._pathColor[e]=t}},{key:"resetReCordData",value:function(){this._nodeList.forEach(function(e){l.revert(e)}),this._nodeList=[],this._runtimeNode=null,this._AllPathMap={},this._memoryDataMap={},this._pathColor={},this._pathCount=0}},{key:"exportFrontNode",value:function(e,t){if(e&&e.nodeDelty&&-1!=t){var a,n,r=PerformanceDataTool.DrawWidth,o=PerformanceDataTool.DrawHeight,i=PerformanceDataTool.StepLength;this._sp.graphics.clear(),this._sp.graphics.drawRect(0,0,r,o,"rgba(150, 150, 150, 0.8)");for(var s=0,l=e.nodeDelty.length;s<l;s++)if(s==t||s==this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_DELTYTIME)){n=e.nodeDelty[s]/33,this.pointArray[s]||(this.pointArray[s]=[]),(a=this.pointArray[s]).length>=i&&a.shift(),a.push(n);var h=s.toString(16),c="#".concat(h).concat(h,"C4").concat(h).concat(h);s==this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_DELTYTIME)&&(c="#FFFFFF"),PerformanceDataTool.stepLengthArrayMap[s]||(PerformanceDataTool.stepLengthArrayMap[s]=new Array(2*PerformanceDataTool.StepLength)),this.updatelineChart(r,o,i,a,c,1,PerformanceDataTool.stepLengthArrayMap[s])}this._sp.graphics.drawLine(0,o/2,r,o/2,"green",1),this._sp.graphics.drawLine(0,o/4*3,r,o/4*3,"red",1)}}},{key:"updatelineChart",value:function(e,t,a,n,r,o,i){switch(o){case 1:for(var s=i,l=0,h=n.length;l<h;l++)s[2*l]=e/a*l,s[2*l+1]=Math.max(t-n[l]*t/this.samplerFramStep,0);this._sp.graphics.drawLines(0,0,s,r,1);break;case 2:for(var c=e/a,f=0,d=n.length;f<d;f++)this._sp.graphics.drawRect(e/a*f,t,c,-Math.min(n[f]*t,t),r)}}},{key:"update",value:function(){var e=(t.Stat.loopCount-this._startFram)/this.samplerFramStep|0;if(!e)return this._runtimeNode=l.create(this._pathCount),void(this._runtimeNode.nodeDelty[this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_STARTTIME)]=performance.now());if(e!=this._nodeList.length){for(var a in this._memoryDataMap)this._runtimeNode.setMemory(this.getNodePathIndex(a),this._memoryDataMap[a]);this._runtimeNode&&(this._runtimeNode.nodeDelty[this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_DELTYTIME)]=performance.now()-this._runtimeNode.nodeDelty[this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_STARTTIME)],this.exportFrontNode(this._runtimeNode,this._runtimeShowPathIndex),i.sendFramData(this._runtimeNode)),this._runtimeNode=l.create(this._pathCount),this._runtimeNode.nodeDelty[this.getNodePathIndex(PerformanceDataTool.PERFORMANCE_STARTTIME)]=performance.now(),this._nodeList.push(this._runtimeNode)}}},{key:"showFunSampleFun",value:function(e){this.runtimeShowPath=e}},{key:"enable",set:function(e){e?(this._startFram=t.Stat.loopCount,this.resetReCordData(),this._sp=new t.Sprite,this._sp.pos(0,400).zOrder=99,t.Laya.stage.addChild(this._sp)):t.Laya.stage.removeChild(this._sp),this._enable=e},get:function(){return this._enable}},{key:"enableDataExport",get:function(){return this._enableDataExport},set:function(e){e?(i.init("player",this),i.enable=e,this.samplerFramStep=1):i.enable=e,this._enableDataExport=e}},{key:"runtimeShowPath",set:function(e){var t=this._AllPathMap[e];for(var a in this.pointArray)delete this.pointArray[a],delete PerformanceDataTool.stepLengthArrayMap[a];this._runtimeShowPathIndex=null!=t?t:-1}}],[{key:"InitLayaPerformanceInfo",value:function(){PerformanceDataTool.instance.InitLayaPerformanceInfo()}},{key:"setDataExportHost",value:function(e){i.Host=e}},{key:"showMemoryData",value:function(e){}},{key:"showFunSampleGroup",value:function(e){}}]),PerformanceDataTool}();s.VERSION="PERFORMANCEDATA:01",s.instance=new s,s.PERFORMANCE_DELTYTIME="deltyTime",s.PERFORMANCE_STARTTIME="startTime",s.PERFORMANCE_LAYA="Laya",s.PERFORMANCE_LAYA_3D="Laya/3D",s.PERFORMANCE_LAYA_2D="Laya/2D",s.PERFORMANCE_LAYA_3D_PRERENDER="Laya/3D/PreRender",s.PERFORMANCE_LAYA_3D_UPDATESCRIPT="Laya/3D/UpdateScript",s.PERFORMANCE_LAYA_3D_PHYSICS="Laya/3D/Physics",s.PERFORMANCE_LAYA_3D_PHYSICS_SIMULATE="Laya/3D/Physics/simulate",s.PERFORMANCE_LAYA_3D_PHYSICS_CHARACTORCOLLISION="Laya/3D/Physics/updataCharacters&Collisions",s.PERFORMANCE_LAYA_3D_PHYSICS_EVENTSCRIPTS="Laya/3D/Physics/eventScripts",s.PERFORMANCE_LAYA_3D_RENDER="Laya/3D/Render",s.PERFORMANCE_LAYA_3D_RENDER_SHADOWMAP="Laya/3D/Render/ShadowMap",s.PERFORMANCE_LAYA_3D_RENDER_CLUSTER="Laya/3D/Render/Cluster",s.PERFORMANCE_LAYA_3D_RENDER_CULLING="Laya/3D/Render/Culling",s.PERFORMANCE_LAYA_3D_RENDER_RENDERDEPTHMDOE="Laya/3D/Render/RenderDepthMode",s.PERFORMANCE_LAYA_3D_RENDER_RENDEROPAQUE="Laya/3D/Render/RenderOpaque",s.PERFORMANCE_LAYA_3D_RENDER_RENDERCOMMANDBUFFER="Laya/3D/Render/RenderCommandBuffer",s.PERFORMANCE_LAYA_3D_RENDER_RENDERTRANSPARENT="Laya/3D/Render/RenderTransparent",s.PERFORMANCE_LAYA_3D_RENDER_POSTPROCESS="Laya/3D/Render/PostProcess",s._surpport=!1,s.DrawWidth=250,s.DrawHeight=250,s.StepLength=250,s.stepLengthArrayMap=new Array;var l=function(){function PerforManceNode(){_classCallCheck(this,PerforManceNode),this.inPool=!1,this.nodeNum=0,this.nodeStart=[],this.nodeDelty=[],this.applyCount=0}return _createClass(PerforManceNode,[{key:"clearData",value:function(){this.nodeStart.length=0,this.nodeDelty.length=0}},{key:"resetData",value:function(e){this.nodeNum=e,this.nodeStart.length=e,this.nodeDelty.length=e}},{key:"getFunStart",value:function(e){this.applyCount++,this.nodeStart[e]=performance.now()}},{key:"getFunEnd",value:function(e){return this.nodeDelty[e]?this.nodeDelty[e]+=0!=this.nodeStart[e]?performance.now()-this.nodeStart[e]:0:(this.nodeDelty[e]=0!=this.nodeStart[e]?performance.now()-this.nodeStart[e]:0,this.nodeNum=this.nodeDelty.length),this.nodeDelty[e]}},{key:"setMemory",value:function(e,t){this.nodeDelty[e]=t}},{key:"getPathData",value:function(e){return this.nodeDelty[e]}}],[{key:"create",value:function(e){var t;return(t=this._pool.length>0?this._pool.pop():new PerforManceNode).resetData(e),t.inPool=!1,t}},{key:"revert",value:function(e){e.inPool=!0,this._pool.push(e),e.clearData()}}]),PerforManceNode}();l._pool=[];var h=function(){function PerformanceNodeParse(){_classCallCheck(this,PerformanceNodeParse)}return _createClass(PerformanceNodeParse,null,[{key:"parsePerformanceFile",value:function(e,t){e.pos=0,PerformanceNodeParse.performanceData=t,PerformanceNodeParse._readData=e,PerformanceNodeParse.READ_DATA();for(var a=0,n=PerformanceNodeParse._blockStr.length;a<n;a++){var r=PerformanceNodeParse._blockStr[a],o=PerformanceNodeParse["READ_"+r];if(null==o)throw new Error("model file err,no this function:"+r);PerformanceNodeParse._readData.pos=PerformanceNodeParse._blockStart[a],o.call(null)}}},{key:"READ_DATA",value:function(){var e=PerformanceNodeParse._readData,t=e.readUTFString();if("PERFORMANCEDATA:01"!=t)throw t+"is not standard Version";for(var a=PerformanceNodeParse._blockStr.length=e.readUint16(),n=0;n<a;n++)PerformanceNodeParse._blockStr[n]=e.readUTFString();for(var r=0;r<a;r++)PerformanceNodeParse._blockStart[r]=e.readInt32(),PerformanceNodeParse._blocklength[r]=e.readInt32()}},{key:"READ_DataInfo01",value:function(){var e=PerformanceNodeParse._readData,t=PerformanceNodeParse.performanceData;PerformanceNodeParse._nodeNums=e.readInt32(),t.samplerFramStep=e.readInt32();for(var a=e.readInt32(),n=0;n<a;n++)t.getNodePathIndex(e.readUTFString());for(var r=e.readInt32(),o=0;o<r;o++)t._memoryDataMap[e.readUTFString()]=1}},{key:"READ_Color",value:function(){for(var e=PerformanceNodeParse._readData,t=PerformanceNodeParse.performanceData,a=e.readInt32(),n=0;n<a;n++)t.setPathDataColor(e.readUTFString(),[e.readUint32(),e.readUint32(),e.readUint32(),e.readUint32()])}},{key:"READ_NodeInfo",value:function(){for(var e,t,a=PerformanceNodeParse._readData,n=PerformanceNodeParse.performanceData,r=0;r<PerformanceNodeParse._nodeNums;r++){t=a.readInt32(),e=l.create(t);for(var o=0,i=t;o<i;o++)e.nodeDelty[o]=a.readFloat32();n._nodeList[r]=e}}}]),PerformanceNodeParse}();h._blockStr=[],h._blockStart=[],h._blocklength=[],h.performanceData=new s,e.PerforManceNode=l,e.PerformanceDataTool=s,e.PerformanceNodeParse=h}(window.Laya=window.Laya||{},Laya);